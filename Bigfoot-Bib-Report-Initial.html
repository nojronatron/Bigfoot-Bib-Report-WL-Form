<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="author" content="Greg KG6SJT" />
    <meta name="author" content="Jon K7RMZ" />
    <meta
      name="description"
      content="Race Tracker Form for Winlink Express created by KG6SJT, modified by K7RMZ for Bigfoot ultra marathon comms-support events."
    />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="favicon.png" />
    <title>Bigfoot Bib Tracker</title>

    <script language="javascript" type="text/javascript">
    
    function cleanAndCountCsvData() {
        let csvData = GetElementById('TheCsvData').value;
        let csvDataArray = csvData.split('\n');
        let nonEmptyLinesCount = 0;

        let cleanCsvDataArray = csvDataArray.map(item => {
            if (item !== undefined && item.length > 0) {
                nonEmptyLinesCount++;
                return item.replace(/ *\, */g, ', ');
            }
        });

        let rejoinedCsvData = cleanCsvDataArray.join('\n');
        GetElementById('TheCsvData').value = rejoinedCsvData;
        GetElementById('entryCount').value = nonEmptyLinesCount;
    }

    // converts bib records from csv-delimited and returns tab-delimited version
    function convertCsvRecordsToTabbed() {
        let csvData = GetElementById('TheCsvData').value;
        return csvData.replace(/, /g, '\t');
    }

    // updates both csv and tabbed bib records into their respective elements
    function updateCsvAndTabRecordsElement(riderNum, bibAction, time, dayOfMonth, shortLoc){
        let previousRecordsComma = GetElementById('TheCsvData').value;
        let previousRecordsTab = convertCsvRecordsToTabbed();
        GetElementById('TheCsvData').value = formatBibRecord(previousRecordsComma, riderNum, bibAction, time, dayOfMonth, shortLoc, ', ');
        GetElementById('TheData').value = formatBibRecord(previousRecordsTab, riderNum, bibAction, time, dayOfMonth, shortLoc, '\t');
    }

    // pluck the top record from the csv data and return to the caller
    function getTopRecordFromCsvData() {
        let csvData = GetElementById('TheCsvData').value;
        let csvDataArray = csvData.split('\n');
        let topRecord = csvDataArray[0];
        return topRecord;
    }

    // copy csv data and convert it to tabbed then set tabbed data to tabbed data element
    function handleCsvDataEdited() {
        let csvData = GetElementById('TheCsvData').value;
        let tabbedData = convertCsvRecordsToTabbed();
        GetElementById('TheData').value = tabbedData;
        let lastEnteredBibRecord = getTopRecordFromCsvData();
        // force a comma-space delimiter for readability
        let lastEnteredBibRecordParts = lastEnteredBibRecord.split(', '); 
        storePreviousRecord(lastEnteredBibRecordParts[0], lastEnteredBibRecordParts[1], lastEnteredBibRecordParts[2], lastEnteredBibRecordParts[3], lastEnteredBibRecordParts[4]);
    }

    // gets an element by id
    function GetElementById(id) {
        return document.getElementById(id);
    }

    // Formats the supplied time as a string in the format HH:MM
    function formatCurrentTime(theTime) {
        if (!theTime || typeof theTime !== 'string') {
            return '0000';
        }

        if (theTime.length < 1) {
            return '0000';
        }

        // copy timeString to a new variable as a for-sure string
        var timeString = theTime.toString();
        // return `${timeString.slice(0, 2)}:${timeString.slice(2)}`;
        var colonIndex = timeString.indexOf(':');

        if (colonIndex > -1) {
            var trimmedHours = timeString.slice(0, colonIndex);
            var sanitizedHours = sanitizeAndPadTime(trimmedHours, 2);
            var trimmedMinutes = timeString.slice(colonIndex, timeString.length);
            var sanitizedMinutes = sanitizeAndPadTime(trimmedMinutes, 2);
            var result = sanitizedHours.toString();
            result = result + sanitizedMinutes;
            return result;
        } else {
            return sanitizeAndPadTime(timeString, 4);
        }
    }

    // sanitize the input time and pad with leading zeros only if needed
    function sanitizeAndPadTime(inputTime, desiredLength) {
        let sanitizedInputTime = inputTime.replaceAll(/[^0-9]/g, '');
        
        if (sanitizedInputTime.length > desiredLength) {
            let result = sanitizedInput.slice(0, desiredLength);
            return result;
        }

        while (sanitizedInputTime.length < desiredLength) {
            sanitizedInputTime = '0' + sanitizedInputTime;
        }

        return sanitizedInputTime;
    }
    
    function getDayOfMonth(date) {
        let day = date.getDate();
        day = GetElementById('yesterday').checked ? (day === 1 ? 31 : day - 1) : day;
        return day.toString().padStart(2, '0');
    }
    
    function ResetForm() {
        ['RiderNum', 'TimeField'].forEach(id => GetElementById(id).value = '');
        GetElementById('yesterday').checked = false;
        GetElementById('RiderNum').focus();
    }

    // return a 4-character time string with leading zeros or trimmed from the right
    function formatPaddedTime(inputTime) {
        let hhmmTimeLen = inputTime.length;

        if (hhmmTimeLen === 4) {
            return inputTime;
        }

        if (hhmmTimeLen < 4) {
            let resultTime = inputTime;
            let lenDiff = 4 - hhmmTimeLen;

            for (let i = 0; i < lenDiff; i++) {
                // prefix with leading zeros until length is 4
                resultTime = '0' + resultTime;
            }
            return resultTime;
        }

        // keep only the first 4 characters
        return inputTime.substring(0, 4);
    }
    
    // validate bib number and time then add bib record to csv and tab record elements
    function handleAddBib(bibAction) {
        const riderNum = GetElementById('RiderNum').value;
        if (riderNum && bibAction != undefined && bibAction.length > 0) {
            // let timeElValue = formatCurrentTime(GetElementById('TimeField').value);
            // let hhmmTime = timeElValue.replace(':', ''); // could be a problem for older browsers
            console.log('TimeField value:', GetElementById('TimeField').value);
            let time = formatCurrentTime(GetElementById('TimeField').value);
            console.log('sanitized time value in hhmm: ', time);
            // let time = hhmmTime;
            let dayOfMonth = getDayOfMonth(new Date());
            let locationVal = GetElementById('Location').value;
            let shortLoc = shortenLocation(locationVal);
            storePreviousRecord(riderNum, bibAction, time, dayOfMonth, shortLoc);
            updateCsvAndTabRecordsElement(riderNum, bibAction, time, dayOfMonth, shortLoc);
            ResetForm();
            cleanAndCountCsvData();
        } else {
            alert('Enter Runner/Bib number');
            GetElementById('RiderNum').focus();
        }
    }

    function elementValuesToLocalStorage() {
        let addressFormatted = GetElementById('address');
        localStorage.setItem('RTrackeradd', addressFormatted.value);
        let locationFormatted= GetElementById('Location');
        localStorage.setItem('RTrackerloc', locationFormatted.value);
        let eventTitleFormatted = GetElementById('EventTitle');
        localStorage.setItem('RTrackertitle', eventTitleFormatted.value);
        let msgNumFormatted = GetElementById('MessageNumber');
        localStorage.setItem('MessageNumber', msgNumFormatted.value);
        let locationLong = lengthenLocation(locationFormatted.value);
        let regulartitle = GetElementById('EventTitle').value + ' ' + locationLong + ' Message #' + msgNumFormatted.value;
        GetElementById('msgsubject').value = regulartitle;
    }

    function shortenLocation(locationVal) {
        let underscoreIdx = locationVal.indexOf('_');
        return locationVal.slice(0, underscoreIdx);
    }

    function lengthenLocation(locationVal) {
        if (!locationVal) {
            return ' ';
        }
        let underscoreIdx = locationVal.indexOf('_') + 1;
        return locationVal.slice(underscoreIdx);
    }

    // set form elements with the values stored in local storage
    function setFormElementsWithLsValues() {
        let storedAddress = localStorage.getItem('RTrackeradd');
        GetElementById('address').value = storedAddress;
        let storedLocation = localStorage.getItem('RTrackerloc');

        if (storedLocation !== '') {
            GetElementById('Location').value = storedLocation;
        } else {
            GetElementById('location').value = '--Choose a station--';
        }

        let storedTitle = localStorage.getItem('RTrackertitle');
        GetElementById('EventTitle').value = storedTitle;
        let storedMsgNumber = localStorage.getItem('MessageNumber');
        GetElementById('MessageNumber').value = storedMsgNumber;
        let locationLong = lengthenLocation(storedLocation);
        let regulartitle = `${storedTitle} ${locationLong} Message #${storedMsgNumber}`;
        GetElementById('msgsubject').value = regulartitle;
        GetElementById('MessageNumber').value = storedMsgNumber;
        GetElementById('FormatNote').value = '* The entries in the message will be TAB delimited, allowing copy/paste into a spreadsheet.';
        copyPreviousRecordFromLsToElement();
    }

    function copyPreviousRecordFromLsToElement() {
        // if previous record key exists in local storage populate the element with string formatted value
        if (localStorage.getItem('previousRecord')) {
            const previousItem = JSON.parse(localStorage.getItem('previousRecord'));
            const prevRunner = previousItem.runner || 'none';
            const prevAction = previousItem.action || 'none';
            const prevTime = previousItem.time || 'none';
            const prevDOM = previousItem.dayOfMonth || 'none';
            const prevMsgNum = previousItem.messageNumber || 'none';
            console.log('previous Runner, Action, Time, DOM, MsgNum', prevRunner, prevAction, prevTime, prevDOM, prevMsgNum);
            const previousRecordString = `#${previousItem.runner}, ${previousItem.action}, ${prevTime}, D:${previousItem.dayOfMonth}, M#${previousItem.messageNumber}`;
            GetElementById('endOfPriorBatch').value = previousRecordString;
        }
    }

    function clearParticipantData() {
        if (confirm('Clear all participant data?')) {
            GetElementById('TheData').value = '';
            GetElementById('TheCsvData').value = '';
            GetElementById('Inbtn').disabled = false;
            GetElementById('Outbtn').disabled = false;
            GetElementById('Dropbtn').disabled = false;
            GetElementById('entryCount').disabled = false;
            GetElementById('entryCount').value = '0';
            let formatNoteText =
            '* Entries in the email will be tab-delimited, allowing copy/paste into a spreadsheet.';
            GetElementById('FormatNote').value = formatNoteText;
            ResetForm();
        }
    }

    // updates the bib time field with the current time in HHMM format
    function putTime() {
        let currentTime = new Date();
        let hours = currentTime.getHours();
        let minutes = currentTime.getMinutes();
        let formattedMinutes = (minutes < 10 ? '0' : '') + minutes; // Add leading zero if minutes is less than 10
        let currentTimeString = `${hours}${formattedMinutes}`;
        GetElementById('TimeField').value = currentTimeString;
    }

      function addIn() {
        handleAddBib('IN');
      }

      function addOut() {
        handleAddBib('OUT');
      }

      function addDrop() {
        handleAddBib('DROP');
      }

      function storePreviousRecord(bibNumber, action, timestamp, dayOfMonth, location) {
        // capture the current message number to store with the previous record
        const messageNumber = GetElementById('MessageNumber').value;
        // initialize a new object and store bibNumber, action, timestamp, dayOfMonth, and location variables as properties
        let previousRecord = {
            runner: bibNumber,
            action: action,
            time: timestamp,
            dayOfMonth: dayOfMonth,
            location: location,
            messageNumber: messageNumber,
        };

        // store this object into localStorage
        localStorage.setItem('previousRecord', JSON.stringify(previousRecord));
      }

      // separator is either '\t' or ', ' depending on format needed
      function formatBibRecord(pTime, tRunner, action, tTime, doM, loc, separator) {
        if (separator !== '\t' && separator !== ', ') {
          separator = '\t';
        }

        storePreviousRecord(tRunner, action, tTime, doM, loc);
        newTime = String(tTime);

        if (tTime.indexOf(':') > -1) {
          newTime = tTime.replace(':', '');
        }

        return (
          tRunner +
          separator +
          action +
          separator +
          newTime +
          separator +
          doM +
          separator +
          loc +
          '\n' +
          pTime
        );
      }

      function autoGrowTextArea(textField) {
        if (textField.clientHeight < textField.scrollHeight) {
          textField.style.height =
            textField.scrollHeight * 2 - textField.clientHeight + 'px';
        }
      }

      // converts bib records in TheData element from tab-separated to comma-separated values
    function convertRawBibRecordsToArray() {
        let bibRecordsRaw = GetElementById('TheData').value;
        const bibRecordsArray = bibRecordsRaw.split('\n');
        const cleanBibRecordsArray = [];
        
        bibRecordsArray.forEach(record => {
            if (record.length > 0) {
                let csvRecord = record.replace(/\t/g, ', ');
                cleanBibRecordsArray.push(csvRecord);
            }
        });

        return cleanBibRecordsArray;
    }

    function createJsonObjectFromFormElements(cleanBibRecordsArray) {
        const jsonObject = {
            FormVersion: GetElementById('FormVersion').value,
            EventTitle: GetElementById('EventTitle').value,
            MessageNumber: GetElementById('MessageNumber').value,
            address: GetElementById('address').value,
            Location: GetElementById('Location').value,
            msgsubject: GetElementById('msgsubject').value,
            entryCount: GetElementById('entryCount').value,
            Comment: GetElementById('Comment').value,
            TheCsvData: cleanBibRecordsArray
        };

        return jsonObject;
    }

    function saveTextAsFile() {
        let fileNameToSaveAs = 'Bigfoot Bib Data ' + dateStampForFile() + '.txt';
        fileNameToSaveAs = prompt('', fileNameToSaveAs);
        const cleanBibRecords = convertRawBibRecordsToArray();
        let formElementsAsJson = createJsonObjectFromFormElements(cleanBibRecords);
        let textToWrite = JSON.stringify(formElementsAsJson, null, 2);

        let textFileAsBlob = new Blob([textToWrite], {
            type: 'application/json',
        });

        if (navigator.msSaveBlob) {
            navigator.msSaveBlob(textFileAsBlob, fileNameToSaveAs);
        } else {
            let downloadLink = document.createElement('a');
            downloadLink.download = fileNameToSaveAs;
            downloadLink.href = URL.createObjectURL(textFileAsBlob);
            downloadLink.onclick = function (e) {
                document.body.removeChild(e.target);
            };
            downloadLink.style.display = 'none';
            document.body.appendChild(downloadLink);
            downloadLink.click();
        }
    }
    
    function dateStampForFile() {
        let d = new Date();
        let thisyear = d.getFullYear();
        let thismonth = d.getMonth() + 1;
        let thisday = d.getDate();
        let h = (d.getHours() < 10 ? '0' : '') + d.getHours();
        let m = (d.getMinutes() < 10 ? '0' : '') + d.getMinutes();

        if (thismonth < 10) {
            thismonth = '0' + thismonth;
        }

        if (thisday < 10) {
            thisday = '0' + thisday;
        }

        return `${thisyear}-${thismonth}-${thisday} ${h}_${m}`;
    }

      // captures each form element value in a JSON object and stores it in hidden element 'parseme'
      function storeFormValuesToHiddenElement() {
        const FormVersion = GetElementById('FormVersion').value;
        const EventTitle = GetElementById('EventTitle').value;
        const MessageNumber = GetElementById('MessageNumber').value;
        const address = GetElementById('address').value;
        const Location = GetElementById('Location').value;
        const msgsubject = GetElementById('msgsubject').value;
        const entryCount = GetElementById('entryCount').value;
        const TheData = GetElementById('TheData').value;
        const Comment = GetElementById('Comment').value;
        const previousRecord = JSON.parse(localStorage.getItem('previousRecord'));

        const formObject = JSON.stringify({
          FormVersion,
          EventTitle,
          MessageNumber,
          address,
          Location,
          msgsubject,
          entryCount,
          TheData,
          Comment,
          previousRecord,
        });

        GetElementById('parseme').value = formObject;
      }

    // takes values stored in parseme hidden element, iterates through form elements and populates them with values
    function populateForm(jsonStringData) {
        if (jsonStringData === undefined || jsonStringData.length < 1) {
            console.log('jsonStringData is empty. Exiting function.');
        } else {
            GetElementById('EventTitle').value = jsonStringData.EventTitle;
            GetElementById('MessageNumber').value = jsonStringData.MessageNumber ? jsonStringData.MessageNumber : 1;
            GetElementById('address').value = jsonStringData.address ? jsonStringData.address : '';
            GetElementById('Location').value = jsonStringData.Location ? jsonStringData.Location : '';
            GetElementById('msgsubject').value = jsonStringData.msgsubject ? jsonStringData.msgsubject : '';
            GetElementById('entryCount').value = jsonStringData.entryCount ? jsonStringData.entryCount : 0;
            GetElementById('Comment').value = jsonStringData.Comment ? jsonStringData.Comment : '';
            GetElementById('endOfPriorBatch').value = jsonStringData.previousRecord ? jsonStringData.previousRecord : '';
            
            const theCsvDataRaw = jsonStringData.TheCsvData;
            let csvData = theCsvDataRaw.join('\n');
            GetElementById('TheCsvData').value = csvData;

            let tabbedData = theCsvDataRaw.map(item => {
                if (item !== undefined && item.length > 0) {
                    return item.replace(/, /g, '\t');
                }
            }).join('\n');

            GetElementById('TheData').value = tabbedData;
            copyPreviousRecordFromLsToElement();
        }
    }

    function SaveData() {
        storeFormValuesToHiddenElement();
        elementValuesToLocalStorage();  // update localstorage values
        saveTextAsFile();
    }

    function incrementMsgNum() {
        const formMsgNum = Number.parseInt(GetElementById('MessageNumber').value, 10);
        const lsMsgNum = Number.parseInt(localStorage.getItem('MessageNumber'), 10);
        const incrMsgNum = formMsgNum ? formMsgNum + 1 : 1;
        GetElementById('MessageNumber').value = incrMsgNum;
        elementValuesToLocalStorage();
    }

    window.addEventListener('load', function () {
        const formVersion = '2.1.2';
        document.getElementById('thisVersion').innerText = `Version ${formVersion}`;
        document.getElementById('FormVersion').value = formVersion;
        localStorage.setItem('Form Version', formVersion);

        // Check the support for the File API
        if (window.File && window.FileReader && window.FileList && window.Blob) {
            let fileSelected = GetElementById('txtfiletoread');

            // begin fileSelected Change Event Listener
            fileSelected.addEventListener('change', function (e) {
                // Set the extension for the file
                let fileExtension = /text.*/;
                // Get the file object
                let fileTobeRead = fileSelected.files[0];
                // Check if the extension matches
                if (fileTobeRead.type.match(fileExtension)) {
                    // Initialize the FileReader object to read the file data
                    let fileReader = new FileReader();

                    fileReader.onload = function (e) {
                        document.getElementById('parseme').value = fileReader.result;

                        try {
                            let jsonData = JSON.parse(document.getElementById('parseme').value);
                            // console.log('filereader.onload json parse of parseme element value: ', jsonData);
                            populateForm(jsonData);
                        } catch (err) {
                            console.error('An error occurred while parsing the JSON data: ', err);
                        }
                    };

                    fileReader.readAsText(fileTobeRead);
                } else {
                    alert('Please select a text file');
                }
            });
            // end fileSelected Change Event Listener
        } else {
            alert('Files are not supported');
        }

        setFormElementsWithLsValues();
        autoGrowTextArea(GetElementById('TheCsvData'));
    });

    </script>

    <style type="text/css">
        body {
            font-family:Arial, Helvetica, sans-serif;
            font-size: 18px;
            background-color: rgb(220, 220, 220);
        }

        @media screen and (width < 650px) {
            label, input, textarea, select, button {
                font-size: .7em;
            }
            input {
                margin: 0.2em 0.2em;
            }
            input[type="checkbox"] {
                width: 1em;
                height: 1em;
            }
            .formTitleHeader {
                font-size: 2em;
            }
            .bibEntries {
                min-height: 3em;
                max-height: 6em;
            }
            .msgHeaderTitle {
                font-size: 0.7em;
            }
            .addressInput {
                min-width: 70%;
            }
            .block-line-div {
                display: block;
            }
            .readOnlyText {
                font-size: 0.6em;
            }
        }

        @media screen and (width >= 650px) {
            label, input, textarea, select, button {
                font-size: 1em;
            }
            input {
                margin: 0.3em 0.3em;
            }
            input[type="checkbox"] {
                width: 1.2em;
                height: 1.2em;
            }
            .formTitleHeader {
                font-size: 3em;
            }
            .bibEntries {
                min-height: 4em;
                max-height: 10em;
            }
            .msgHeaderTitle {
                font-size: 1.1em;
            }
            .addressInput {
                max-width: 55%;
            }
            .block-line-div {
                display: inline;
            }
        }

        hr {
            height: 0.1em;
            width: 90%;
        }
        textarea {
            width: 96%;
        }

        ul {
            list-style-type: none;
        }

        li {
            padding: 0.2rem;
        }

        .screen-reader {
            /* only screen readers see this element */
            position: absolute;
            left: -500px;
            top: auto;
            width: 1px;
            height: 1px;
            overflow: hidden;
        }

        .div-across-auto-align {
            width:100%;
            margin:auto; 
            text-align:center;
        }

        .formTitleHeader {
            text-align: center;
            color:rgb(0,0,255);
            font-style: italic;
        }
      
        .msgHeaderTitle {
            color: rgb(0,0,255);
            text-align: center;
        }

        .maxSizeInputWidth {
            min-width: 75%;
        }

        .readOnlyText {
            color: rgb(84, 84, 84) !important;
            outline: none !important;
            cursor: default !important;
            opacity: unset !important;
        }

      /* Pop-up content shifted off-screen when not in view. Still readable by screen-reader software. When targeted it fills the browser window. */
      .pop-up {
        position: absolute;
        top: 0em;
        left: -500em;
        
      }

      .pop-up:target {
        position: static;
        left: 0em;
      }

      /* The pop-up itself */
      .popBox {
        background: rgb(255, 255, 255);
        /* alternatively fixed width / height and negative margins from 50% */
        position: absolute;
        left: 2em;
        right: 2em;
        top: 2em;
        bottom: 2em;
        z-index: 10;
        border: 3px solid rgb(0, 0, 150);
        /* CSS3 where available: rounded corners, drop-shadow, and fade in. */
        border-radius: 1rem;
        box-shadow: 0rem 0.5rem 0.5rem rgb(255, 255, 255);
        opacity: 0;
        transition: opacity 0.8s ease-out;
      }

      :target .popBox {
        position: fixed;
        opacity: 1;
      }

      /* The pop-ups close link, moved via CSS to the top right of the pop-up */
      .close:link,
      .close:visited {
        position: absolute;
        top: -0.75em;
        right: -0.75em;
        display: block;
        line-height: 1.8;
        padding: 0em;
        text-align: center;
        text-decoration: none;
        background-color: rgb(0,0,0);
        border: 2px solid rgb(255,255,255);
        color: rgb(255,255,255);
        border-radius: 1em;
        box-shadow: 0rem 0rem 0.5rem 0.5rem;
      }

      .close:before {
        content: 'Click To Close This';
        margin: 3em;
      }

      .close:hover,
      .close:active,
      .close:focus {
        box-shadow: 0rem 0rem 0.5rem 0.5rem;
        background-color: rgb(192, 192, 192);
        color: rgb(0,0,0);
      }

      .close span {
        text-indent: -200em;
        display: block;
      }

      /* The pop-up content div will scroll if it has too much content */
      .popScroll {
        position: absolute;
        top: 1rem;
        left: 1rem;
        right: 1rem;
        bottom: 1rem;
        overflow-y: auto;
        padding-right: 0.5em;
      }

      input {
        padding: 0.2em 0.2em;
        border-radius: 0.5rem;
      }

      input[type='submit'] {
        color: rgb(0, 0, 0);
        font-weight: bold;
        background-color: rgb(113, 169, 253);
        padding-left: 0.8em;
        padding-right: 0.8em;
      }

      .clearDataButton {
        color: black;
        background-color: rgb(255, 153, 0);
        font-weight: bold;
      }

      input[type='button'] {
        color: black;
        padding-left: 0.8em;
        padding-right: 0.8em;
      }

      textarea, select {
        padding: 0.3em 0.3em;
        border: rgb(0,0,0) solid 0.15em;
        border-radius: 0.5rem;
      }

    input:hover, textarea:hover, select:hover {
        cursor: pointer;
        opacity: 0.8;
    }

    input:focus, textarea:focus, select:focus {
        outline: rgb(255, 153, 0) solid 3px;
    }
    </style>
  </head>

<body>
    <section>
    <form 
        onsubmit="return confirm('To complete your form submission, click OK and close the browser tab. You will return to the new message window so you can post your message to the outbox.');"
        method="post" id="myform" enctype="multipart/form-data" action="http://{FormServer}:{FormPort}">
            <div style="text-align: center;">
                <label class="formTitleHeader">Bigfoot Bib Report</label>
            </div>
            <div style="text-align: center;">
                <input type="button" value="Form Information - READ" onclick="location.href='#pop1'" />
                <label id="thisVersion"></label>
            </div>
        <hr />

        <div class="msgHeaderTitle">Message Header</div>
        <div class="div-across-auto-align">
            <div class="block-line-div">
                <label for="EventTitle">Event Name:</label>
                <input name="EventTitle" type="text" id="EventTitle" maxlength="40" onchange="elementValuesToLocalStorage();" placeholder="Race or Event Name" required />
            </div>
            <div class="block-line-div">
                <label for="MessageNumber">Message #</label>
                <input name="MessageNumber" type="text" id="MessageNumber" maxlength="3" style="max-width: 3em;" onchange="elementValuesToLocalStorage();" />
                <input name="incrMsgNum" type="button" id="incrMsgNum" value="increment" onclick="incrementMsgNum();" />
                <!-- invisible label that screen readers can still use -->
                <label for="incrMsgNum" class="screen-reader">Increment</label>
            </div>
        </div>

        <div class="div-across-auto-align">
            <div class="block-line-div">
                <label for="address">Send to:</label>
                <input name="address" type="text" id="address" class="addressInput" maxlength="40" onchange="elementValuesToLocalStorage();"
                    title="Separate multiple calls or addresses with a semicolon;" placeholder="Winlink Radio Call or Email"
                    required />
            </div>

            <div class="aidStnSpan block-line-div">
                <label for="Location">Aid Station:</label>
                <select name="Location" id="Location" onchange="elementValuesToLocalStorage();" required>
                    <option value="MM_Marble Mountain SnoPark">Marble Mountain SnoPark</option>
                    <option value="BL_Blue Lake">Blue Lake</option>
                    <option value="WR_Windy Ridge">Windy Ridge</option>
                    <option value="JR_Johnston Ridge">Johnston Ridge</option>
                    <option value="CW_Coldwater Lake">Coldwater Lake</option>
                    <option value="NP_Norway Pass">Norway Pass</option>
                    <option value="EP_Elk Pass">Elk Pass</option>
                    <option value="WM_Wright Meadow (Rd.9327)">Wright Meadow (Rd.9327)</option>
                    <option value="SB_Spencer Butte">Spencer Butte</option>
                    <option value="LR_Lewis River">Lewis River</option>
                    <option value="QR_Quartz Ridge">Quartz Ridge</option>
                    <option value="CB_Council Bluff">Council Bluff</option>
                    <option value="CH_Chain of Lakes">Chain of Lakes</option>
                    <option value="KT_Klickitat">Klickitat</option>
                    <option value="TS_Twin Sisters">Twin Sisters</option>
                    <option value="OC_Owens Creek">Owen&acute;s Creek</option>
                    <option value="FN_Finish Line">Finish (Bigfoot Base)</option>
                </select>
            </div>
        </div>

        <!-- hidden elements -->
        <input name="FormVersion" type="hidden" id="FormVersion" />
        <input name="FormatNote" type="hidden" id="FormatNote"
            value="* Entries in the email will be tab-delimited, allowing copy/paste into a spreadsheet." />
        <input type="file" id="txtfiletoread" accept=".txt" style="display: none" />
        <input name="sendto" type="hidden" id="sendto" />
        <textarea name="parseme" id="parseme" style="display: none"></textarea>
        <!-- end hidden elements -->

        <div class="div-across-auto-align">
            <label for="msgsubject">Subject:</label>
            <input name="msgsubject" type="text" id="msgsubject" readonly="readonly" maxlength="40" class="maxSizeInputWidth readOnlyText" />
        </div>

        <hr />
        <div class="msgHeaderTitle">Bib Data Entry</div>

        <div class="div-across-auto-align">
            <div class="block-line-div">
                <label for="RiderNum">Bib Number:</label>
                <input name="RiderNum" type="text" id="RiderNum" maxlength="15" style="max-width: 6em;" required />
            </div>
            <div class="block-line-div">
                <label for="TimeField">Time:</label>
                <input name="TimeField" type="text" id="TimeField" maxlength="6" style="max-width: 6em;" required />
                <input type="checkbox" id="yesterday" name="yesterday" value="Yesterday" />    
                <label for="yesterday">Yesterday</label>
            </div>
        </div>

        <div id="inOutDropBtns"  class="div-across-auto-align">
            <div class="block-line-div">
                <label>Click an Action button to create a record:</label>
            </div>
            <div class="block-line-div">
                <input name="Inbtn" type="button" id="Inbtn" onclick="addIn();" value="In"
                title="Participant arrived at this station." />
                <input name="Outbtn" type="button" id="Outbtn" onclick="addOut();" value="Out"
                title="Participant departed from this station." />
                <input name="Dropbtn" type="button" id="Dropbtn" onclick="addDrop()" value="Drop"
                title="Participant dropped from race." />
            </div>
        </div>

        <hr />

            <div class="div-across-auto-align">
                <label for="entryCount">Entry Count:</label>
                <input name="entryCount" type="text" id="entryCount" size="3" class="readOnlyText" readonly title="Number of bib entries submitted." />
                <label for="endOfPriorBatch">End Of Prior:</label>
                <input name="endOfPriorBatch" type="text" id="endOfPriorBatch" size="25" class="readOnlyText" readonly title="The last saved bib record."></input>
            </div>
            <div class="div-across-auto-align">
                <textarea name="TheCsvData" placeholder="Limit to a sensible number of entries." id="TheCsvData" class="bibEntries" maxlength="1200"></textarea> <!-- visible, put csv items here -->
                <textarea name="TheData" id="TheData" class="bibEntries" maxlength="1200" style="display:none"></textarea> <!-- style display:none, put tab delim data here -->
            </div>
            <div class="div-across-auto-align">
                <label for="Comment">Comment:</label>
                <textarea name="Comment" id="Comment" maxlength="340" placeholder="Enter a short comment, space is very limited!"></textarea>
            </div>

        <div class="div-across-auto-align">
            <div class="block-line-div">
            <input title="After submitting, close browser, then address message for posting" class="SubmitBtn"
                enctype="multipart/form-data" id="Submit" method="Post" name="Submit" value="SUBMIT" type="submit" />
            <input name="savebtn" type="button" class="saveDataButton" id="savebtn" onclick="SaveData()"
                value="Save Race data" title="Save data to a file." />
            </div>            
            <div class="block-line-div">
            <input name="loadbtn" type="button" class="loadDataButton" id="loadbtn"
                onclick="document.getElementById('txtfiletoread').click();" value="Load Race data"
                title="Load data from a file." />
            <input name="doclear" type="button" id="doclear" onclick="clearParticipantData()" value="Clear Entries"
                    title="Clear all runner entries." class="clearDataButton" />
            </div>
        </div>
    </form>
    </section>

    <section>
    <div id="pop1" class="pop-up">
        <!-- The pop-up block -->

        <div class="popBox">
            <!-- If the content becomes larger than the pop-up this div will scroll the content -->
            <a href="#close" class="close"></a>

            <div class="popScroll">
                <h1>Winlink Operator Instructions</h1>

                <h2>About This Form</h2>
                
                <p>This form has been coded using technologies available to desktop browsers all the way back to March of 2010, including Chrome, Firefox, IE 11, Opera, and Safari iOS. Support for Edge (released in 2015) is also included.</p>

                <p>Mobile device browsers are supported, including Chrome, Samsung Internet, Opera Mobile, and Android Firefox. You can rotate your device to change the view and the form will adjust its layout to accommodate the new screen dimensions (try it now!)</p>
                
                <p>Some mobile device browsers have quirks:</p>
                
                <ul>
                    <li>The on-screen keyboard will definitely get in your way while adding data on smaller devices. Use a compatible external keyboard if you have one.</li>
                    <li>Tab-order is not always correct. Just tap the field you want to change/fill-in to work around the problem.</li>
                </ul>

                <h2>Topics</h2>
                
                <p>The form is broken up into three sections:</p>

                <ul>
                    <li>Top: Form header with event, location, and message information.</li>
                    <li>Middle: Entering and viewing bib data.</li>
                    <li>Bottom: Add comments, save and restore bib data, and submit the data for posting a new Winlink Express message.</li>
                </ul>

                <p>Note: This form provides <em>limited keyboard-only support</em>.</p>

                <ul>
                    <li>
                        <kbd>Tab</kbd> key to move between screen elements.
                    </li>
                    <li>
                        <kbd>Spacebar</kbd> or <kbd>Enter</kbd> to activate a highlighted element.
                    </li>
                    <li>
                        <kbd>Enter</kbd> will try to press the <button>Submit</button> button if required fields have data in them.
                    </li>
                </ul>

                <p>If you have suggestions for how to improve keyboard-only mode support, please talk with Jon K7RMZ or see the <a href="https://github.com/nojronatron/Bigfoot-Bib-Report-WL-Form">GitHub Project</a> for more information.</p>

                <h2>Top section: Header and Message Information</h2>

                <ol>
                    <li>Enter this Event Name for example &quot;Bigfoot 2024&quot;.</li>
                    <li>Enter a Message Number starting with 1. You can use the <button>Increment</button> once or just enter a number.</li>
                    <li>Enter the recipient's amateur call sign in Send To field. You can add other recipients in the Winlink Message <em>after submitting</em>.</li>
                    <li>Aid Station: Click or press the <kbd>Spacebar</kbd> to see the list. Click or use <kbd>arrows</kbd> and <kbd>Enter</kbd> key to select the Aid Station for which the bib data applies.</li>
                    <li>Subject Line: It will be entered automagically for you. Resist the urge to change it.</li>
                </ol>

                <h2>Middle section: Entering and Viewing Bib Data</h2>

                <p>Enter one Bib Number for Runner that arrives (IN), leaves (OUT), or bows-out of the event (DROP):</p>

                <ol>
                    <li>Enter Bib Number: Limited to 15 characters (should be more than enough for any event).</li>
                    <li>Enter The Time: This should be 24hr time like <em>HH:MM</em> although the colon is optional. Your browser might suggest the current time.</li>
                    <li>Yesterday: Check this box to set the day of the month to yesterday.</li>
                    <li>Click IN (arrived), OUT (exited), or DROP (bowed out of event) once to enter that bib into the text field below.</li>
                    <li>Entry Count: A read-only field shows the number of bib records you have entered.</li>
                    <li>End Of Prior: A read-only field that displays the last-submitted entry in a prior message created with this Form. Must leave browser open to use this. Format is `bib, action, time, day of month, message number`</li>
                </ol>

                <h3>About IN, OUT, and DROP Actions</h3>

                <ul>
                    <li>
                        IN: The runner (bib) arrived at the Aid Station.
                    </li>
                    <li>
                        OUT: The runner exited the Aid Station.
                    </li>
                    <li>
                        DROP: Use if the runner has notified Aid Station Staff that they are bowing out of the race, or
                        they have been disqualified by race officials.
                    </li>
                </ul>

                <p>Each runner can only have one Action set per entry. If you know that Bib 123 entered at 12:34 today and exited at 14:34 today, you would record 123 12:34 IN, and then record 123 14:34 OUT, totally 2 entries.</p>

                <p>If you don't know the <em>exact time</em> of the bib event ask the Aid Station captain and volunteers. You could also try to locate the runner's crew and ask if they know. If you don't find an answer, chances are you have a better idea than anyone else nearby, so make a fair estimate based on your experience, enter that time, and add a concise note in the Comment field about that bib number.</p>
               
                <p>Stay on top of your runner records lists. Even if you cannot send data via Winlink for some reason, keep entering data into this Form and click <button>Save Race data</button> to store a list on your device. Start a new Form and repeat this process until you can send the data via Winlink using the <button>Load Race data</button> or by other means. You will have an easier time keeping track of runners this way by viewing files stored on your device.</p>

                <p>The sooner you get valid data to Bigfoot Base, the better the hams and the event organizers understand the status of all runners and Aid Stations. Since runners come and go from Aid Stations both day and night, you will end up with a list of runners that arrived, exited, or dropped sometime in the past. If you get behind by more than a day or so, you will find the record-keeping duty much more challenging than it needs to be.</p>

                <h3>Number of Entries</h3>

                <p>This accurately counts the number of bib entries currently stored in the form. This number will update every time you click IN, OUT, or DROP, and any time you make a direct edit to the comma-separated values.</p>

                <h2>Bottom Section: Comment, Save, Restore, and Submit Bib Data</h2>

                <h3>Comment Field</h3>

                <p>For any bib entries that need additional explanation (like DROP) use the &quot;Comments&quot; area to free-form a <em>short and to the point</em> statement.</p>

                <p>If the message is too long or complex for the Comment field, contact Bigfoot Base via a separate Winlink Message, voice radio, or cellphone to relay the information to them.</p>

                <h3>Save and Load buttons</h3>

                <p>Use the Save Data Race Data button to store the bib entries into a plain text file.</p>

                <ul>
                    <li>The file will be named with the current date and time with a &quot;txt&quot; file extension so any text editor can open it.</li>
                    <li>The file will be stored in your browser's download folder (default, see Browser Settings to confirm or change this).</li>
                    <li>You can rename the downloaded file to something more meaningful without harming the data or the operation of this Form.</li>
                </ul>

                <h3>Submit Button</h3>
                
                <p>If you launched this form using Winlink Express, use the <button>Submit</button> button to have Winlink Express automatically create a new, well formatted message. On-screen information will guide you through the submission process.</p>
                
                <p>The information that is sent in the new Message via WinLink can be copied and pasted directly into an excel spreadsheet or other database software. This is what Bigfoot Base does when they receive the message. If it is not formatted exactly as this Form does it, they might call you on the radio and ask for you to resubmit or clarify information. This is not a good use of your time, so refrain from editing the "posted" Winlink Message after submitting this Form.</p>
                
                <p>The Subject Line will be formatted for you, for example: <code>BigFoot 2023 Elk Pass Message #1</code>. Below is a breakdown of how the subject line is created:</p>

                <ul>
                    <li>BigFoot 2023: The Race or Event Name entered at the top of the form.</li>
                    <li>Elk Pass: The Aid Station selected at the top of the form.</li>
                    <li>Message #1: The Message Number entered at the top of the form.</li>
                </ul>

                <p>The &quot;Send To&quot; data is used to address the Winlink Message to the intended recipient and is not included in the subject line.</p>

                <h3>Clear Entries button</h3>
                
                <p>Use the <button>Clear Entries</button> button to remove <em>all bib record entries</em>. USE WITH CAUTION <em>there is no undo button</em>.
                    See the above sub-section &quot;Saving and Loading Race Data&quot; for more information.</p>
                <hr />
                
                <h2>Consider This</h2>
                
                <p>Load this Form on a tablet or laptop computer and track runners until you have several dozen. Use the <button>Save Race data</button> button to save the data to a thumbdrive to share the data with the Winlink Operator, who can then open a new message form and click <button>Load Race data</button> to load the collected data and send it. This will save you time and effort, and might even free-up your Winlink Operator to perform other duties while you collect bib records on your phone or tablet, instead of pen and paper.</p>
                
                <p>If you have a computer network savvy ham on your team, try networking your devices within a small WiFi, so you can just transfer the saved race data directly to the Winlink computer at any time.</p>
                
                <p>There are many possible ways to slice this cake. Use your imagination and allow this form to help you be efficient in tracking runners.</p>

                <h2>Credits and Thanks</h2>
                
                <p>The original form was designed by Greg KG6SJT, a member of the <a href="https://winlink.org">Winlink Development Team</a></p>
                
                <p>Custom redesign and ongoing development: Jon K7RMZ (<a href="https://github.com/nojronatron">GitHub</a>)</p>
                
                <p>Design and code assistance: Mark K7TUM</p>
                
                <p>Feature and dev-ops assistance: Jason KI7TYU</p>
            </div>
            <!-- The close pop-up link correctly positioned at the end of the content block -->

        </div>
    </div>

    </section>

    <script language="javascript" type="text/javascript">
        // USE THIS SECTION to add event listeners to form elements
        let defaultBibValue = "000";
        let minFieldLength = 1;
        let timeFieldElement = GetElementById('TimeField');
        let riderNumberElement = GetElementById('RiderNum');
        let csvDataElement = GetElementById('TheCsvData');

        csvDataElement.addEventListener('blur', function() {
            cleanAndCountCsvData();
            handleCsvDataEdited();
        });

        timeFieldElement.addEventListener('blur', function() {
            this.value = this.value.trim();
            // set default to current time if field is empty
            if (this.value.length < minFieldLength) {
                putTime();
            } else {
                let sanitizedTimeString = sanitizeAndPadTime(this.value, 4);
                GetElementById('TimeField').value = sanitizedTimeString;
            }
        });

        riderNumberElement.addEventListener('blur', function() {
            this.value = this.value.trim();
            // set default value if field is empty
            if (this.value < minFieldLength) {
                this.value = defaultBibValue;
            }

            this.value = this.value.toUpperCase();
            putTime();
        });
    </script>
</body>
</html>
