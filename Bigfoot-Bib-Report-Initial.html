<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="author" content="Greg KG6SJT" />
    <meta name="author" content="Jon K7RMZ" />
    <meta
      name="description"
      content="Race Tracker Form for Winlink Express created by KG6SJT, modified by K7RMZ for Bigfoot ultra marathon comms-support events."
    />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Bigfoot Bib Tracker</title>

    <script language="javascript" type="text/javascript">
      function store() {
        var addressFormatted = document.getElementById('address');
        localStorage.setItem('RTrackeradd', addressFormatted.value);
        var locationFormatted = document.getElementById('Location');
        localStorage.setItem('RTrackerloc', locationFormatted.value);
        var eventTitleFormatted = document.getElementById('EventTitle');
        localStorage.setItem('RTrackertitle', eventTitleFormatted.value);
        var msgNumFormatted = document.getElementById('MessageNumber');
        localStorage.setItem('RTrackermsgNum', msgNumFormatted.value);
        var locationLong = lengthenLocation(locationFormatted.value);
        var regulartitle =
          document.getElementById('EventTitle').value +
          ' ' +
          locationLong +
          ' Message #' +
          msgNumFormatted.value;
        document.getElementById('msgsubject').value = regulartitle;
      }

      function shortenLocation(locationVal) {
        var underscoreIdx = locationVal.indexOf('_');
        return locationVal.slice(0, underscoreIdx);
      }

      function lengthenLocation(locationVal) {
        if (!locationVal) {
          return ' ';
        }
        var underscoreIdx = locationVal.indexOf('_') + 1;
        return locationVal.slice(underscoreIdx);
      }

      // set message header form elements if empty
      function loadMessageHeadersIfEmpty() {
        const storedAddress = localStorage.getItem('RTrackeradd');
        const storedLocation = localStorage.getItem('RTrackerloc');
        const storedTitle = localStorage.getItem('RTrackertitle');
        const storedMsgNumber = localStorage.getItem('RTrackermsgNum');

        if (document.getElementById('address').value == '' && storedAddress != '') {
          document.getElementById('address').value = storedAddress;
        }
        if (document.getElementById('Location').value == '' && storedLocation != '') {
          document.getElementById('Location').value = storedLocation;
        }
        if (document.getElementById('EventTitle').value == '' && storedTitle != '') {
          document.getElementById('EventTitle').value = storedTitle;
        }
        if (document.getElementById('MessageNumber').value == '' && storedMsgNumber != '') {
          document.getElementById('MessageNumber').value = storedMsgNumber;
        }

      }

      // set form elements with the values stored in local storage
      function setFormElementsWithLsValues() {
        var storedAddress = localStorage.getItem('RTrackeradd');
        document.forms[0].address.value = storedAddress;
        var storedLocation = localStorage.getItem('RTrackerloc');
        // the following code causes a bug in Aid Station selector
        if (storedLocation != '') { // if statement is not used
          // console.log('storedLocation has value:',storedLocation);
          document.forms[0].Location.value = storedLocation;
        } else {
          // console.log('storedLocation is empty',storedLocation);
          document.forms[0].location.value = '--Choose a station--';
        }
        // end suspected bug
        var storedTitle = localStorage.getItem('RTrackertitle');
        document.forms[0].EventTitle.value = storedTitle;
        var storedMsgNumber = localStorage.getItem('RTrackermsgNum');
        document.forms[0].MessageNumber.value = storedMsgNumber;
        var locationLong = lengthenLocation(storedLocation);
        var regulartitle =
          document.getElementById('EventTitle').value +
          ' ' +
          locationLong +
          ' Message #' +
          document.getElementById('MessageNumber').value;
        document.getElementById('msgsubject').value = regulartitle;
        document.getElementById('MessageNumber').value = storedMsgNumber;
        var formatNoteText =
          '* The entries in this email are TAB delimited. This allows you to copy and paste into a spreadsheet.';
        document.getElementById('FormatNote').value = formatNoteText;
        copyPreviousRecordFromLsToElement();
      }

      function copyPreviousRecordFromLsToElement() {
        // if previous record key exists in local storage populate the element with string formatted value
        if (localStorage.getItem('previousRecord')) {
            const previousItem = JSON.parse(localStorage.getItem('previousRecord'));
            const prevRunner = previousItem.runner || 'none';
            const prevAction = previousItem.action || 'none';
            const prevTime = previousItem.time || 'none';
            const prevDOM = previousItem.dayOfMonth || 'none';
            const prevMsgNum = previousItem.messageNumber || 'none';
            console.log('previousItem:',previousItem);
            console.log('previous Runner, Action, Time, DOM, MsgNum',prevRunner,prevAction,prevTime,prevDOM,prevMsgNum);
            const previousRecordString = `#${previousItem.runner}, ${previousItem.action}, ${previousItem.time}, D:${previousItem.dayOfMonth}, M#${previousItem.messageNumber}`;
            document.getElementById('endOfPriorBatch').value = previousRecordString;
        }
      }

      function ClearParticipantData() {
        document.forms[0].TheData.value = '';
        document.getElementById('RiderNum').focus();
        document.getElementById('Inbtn').disabled = false;
        document.getElementById('Outbtn').disabled = false;
        document.getElementById('Dropbtn').disabled = false;
        document.getElementById('RiderNum').disabled = false;
        document.getElementById('numlines').disabled = false;
        document.getElementById('numlines').value = '0';
        var formatNoteText =
          '* The entries in this email are TAB delimited. This allows you to copy and paste into a spreadsheet.';
        document.getElementById('FormatNote').value = formatNoteText;
      }

      function countLines2() {
        delBlankLines2();
        var text1 = document.getElementById('TheData').value;
        var text2 = text1.replace(/\s+$/, '');
        var split = text2.split('\n');

        document.forms[0].numlines.value = split.length;

        document.getElementById('numlines').disabled = false;
      }

      function rtrim(stringToTrim) {
        return stringToTrim.replace(/\s+$/, '');
      }

      function delBlankLines2() {
        var stringArray = document.getElementById('TheData').value.split('\n');
        var temp = [''];
        var x = 0;

        for (var i = 0; i < stringArray.length; i++) {
          if (stringArray[i].trim() != '') {
            temp[x] = stringArray[i];
            x++;
          }
        }

        temp = temp.join('\n');
        var lookfor = '//';
        var temp = temp.replace(/lookfor/gm, '/');
        document.getElementById('TheData').value = temp + '\n';
      }

      function Docleardata() {
        if (confirm('Clear all participant data?')) {
          ClearParticipantData();
        }
      }

      function putTime() {
        document.getElementById('Timefld').value = RunnerTime();
      }

      function RunnerTime(RightNow) {
        var d = new Date();
        thismonth = d.getMonth();
        thismonth = thismonth + 1;

        if (thismonth < 10) {
          thismonth = '0' + thismonth;
        }

        thisday = d.getDate();
        if (thisday < 10) {
          thisday = '0' + thisday;
        }

        h = (d.getHours() < 10 ? '0' : '') + d.getHours();
        m = (d.getMinutes() < 10 ? '0' : '') + d.getMinutes();
        var myprompt = h + ':' + m;
        return myprompt;
      }

      function AddIn() {
        temp = document.getElementById('RiderNum').value;

        if (temp.length > 0) {
          temp = rtrim(temp);
          var temp = temp.replace(/ /g, '');
          var TheRunner = temp;
          var TheTime = document.getElementById('Timefld').value;

          if (TheTime.length < 4) {
            TheTime = '0' + TheTime;
          }

          if (TheTime.search(':') < 0) {
            TheTime = [TheTime.slice(0, 2), ':', TheTime.slice(2)].join('');
          }

          var theDate = new Date();
          toDay = theDate.getDate();

          if (document.getElementById('yesterday').checked) {
            if (toDay == 1) {
              toDay = 31; // there are far more months with 31 than otherwise.
            } else {
              toDay -= 1;
            }
          }

          dayOfMonth = String(toDay);

          if (dayOfMonth.length < 2) {
            dayOfMonth = '0' + dayOfMonth;
          }

          var locationVal = document.getElementById('Location').value;
          var shortLoc = shortenLocation(locationVal);
          var Previoustime = document.getElementById('TheData').value;
          document.getElementById('TheData').value = FormatBibRecord(
            Previoustime,
            TheRunner,
            'IN',
            TheTime,
            dayOfMonth,
            shortLoc
          );
          document.getElementById('RiderNum').value = '';
          document.getElementById('Timefld').value = '';
          yesterday.checked = false;
          document.getElementById('RiderNum').focus();
          countLines2();
        } else {
          alert('Enter Runner/Bib number');
          document.getElementById('RiderNum').focus();
        }
      }

      function AddOut() {
        temp = document.getElementById('RiderNum').value;

        if (temp.length > 0) {
          temp = rtrim(temp);
          var temp = temp.replace(/ /g, '');
          var TheRunner = temp;
          var TheTime = document.getElementById('Timefld').value;

          if (TheTime.length < 4) {
            TheTime = '0' + TheTime;
          }

          if (TheTime.search(':') < 0) {
            TheTime = [TheTime.slice(0, 2), ':', TheTime.slice(2)].join('');
          }

          var theDate = new Date();
          toDay = theDate.getDate();

          if (document.getElementById('yesterday').checked) {
            if (toDay == 1) {
              toDay = 31; // there are far more months with 31 than otherwise.
            } else {
              toDay -= 1;
            }
          }

          dayOfMonth = String(toDay);

          if (dayOfMonth.length < 2) {
            dayOfMonth = '0' + dayOfMonth;
          }

          var locationVal = document.getElementById('Location').value;
          var shortLoc = shortenLocation(locationVal);
          var Previoustime = document.getElementById('TheData').value;
          document.getElementById('TheData').value = FormatBibRecord(
            Previoustime,
            TheRunner,
            'OUT',
            TheTime,
            dayOfMonth,
            shortLoc
          );
          document.getElementById('RiderNum').value = '';
          document.getElementById('Timefld').value = '';
          yesterday.checked = false;
          document.getElementById('RiderNum').focus();
          countLines2();
        } else {
          alert('Enter Runner/Bib number');
          document.getElementById('RiderNum').focus();
        }
      }

      function AddDrop() {
        temp = document.getElementById('RiderNum').value;

        if (temp.length > 0) {
          temp = rtrim(temp);
          var temp = temp.replace(/ /g, '');
          var TheRunner = temp;
          var TheTime = document.getElementById('Timefld').value;

          if (TheTime.length < 4) {
            TheTime = '0' + TheTime;
          }

          if (TheTime.search(':') < 0) {
            TheTime = [TheTime.slice(0, 2), ':', TheTime.slice(2)].join('');
          }

          var theDate = new Date();
          toDay = theDate.getDate();

          if (document.getElementById('yesterday').checked) {
            if (toDay == 1) {
              toDay = 31; // there are far more months with 31 than otherwise.
            } else {
              toDay -= 1;
            }
          }

          dayOfMonth = String(toDay);

          if (dayOfMonth.length < 2) {
            dayOfMonth = '0' + dayOfMonth;
          }

          var locationVal = document.getElementById('Location').value;
          var shortLoc = shortenLocation(locationVal);
          var Previoustime = document.getElementById('TheData').value;
          document.getElementById('TheData').value = FormatBibRecord(
            Previoustime,
            TheRunner,
            'DROP',
            TheTime,
            dayOfMonth,
            shortLoc
          );
          document.getElementById('RiderNum').value = '';
          document.getElementById('Timefld').value = '';
          yesterday.checked = false;
          document.getElementById('RiderNum').focus();
          countLines2();
        } else {
          alert('Enter Runner/Bib number');
          document.getElementById('RiderNum').focus();
        }
      }

      function storePreviousRecord(bibNumber, action, timestamp, dayOfMonth, location) {
        // capture the current message number to store with the previous record
        const messageNumber = document.getElementById('MessageNumber').value;
        // initialize a new object and store bibNumber, action, timestamp, dayOfMonth, and location variables as properties
        var previousRecord = {
            runner: bibNumber,
            action: action,
            time: timestamp,
            dayOfMonth: dayOfMonth,
            location: location,
            messageNumber: messageNumber,
        };

        // store this object into localStorage
        localStorage.setItem('previousRecord', JSON.stringify(previousRecord));
      }

      function FormatBibRecord(pTime, tRunner, action, tTime, doM, loc) {
        storePreviousRecord(tRunner, action, tTime, doM, loc);
        newTime = String(tTime);

        if (tTime.indexOf(':') > -1) {
          newTime = tTime.replace(':', '');
        }

        return (
          tRunner +
          '\t' +
          action +
          '\t' +
          newTime +
          '\t' +
          doM +
          '\t' +
          loc +
          '\n' +
          pTime
        );
      }

      function AutoGrowTextArea(textField) {
        if (textField.clientHeight < textField.scrollHeight) {
          textField.style.height =
            textField.scrollHeight * 2 - textField.clientHeight + 'px';
        }
      }

      function setfocus() {
        document.getElementById('Timefld').focus();
        return false;
      }

      function saveTextAsFile() {
        var textToWrite = document.getElementById('parseme').value; // missing JSON.parse?
        console.log('data copied from hidden element before saving to disk', document.getElementById('parseme').value);
        var fileNameToSaveAs = 'Bigfoot Bib Data ' + DateforFile() + '.txt';
        fileNameToSaveAs = prompt('', fileNameToSaveAs);

        /* Saves a text string as a blob file*/
        var ie = navigator.userAgent.match(/MSIE\s([\d.]+)/),
          ie11 =
            navigator.userAgent.match(/Trident\/7.0/) &&
            navigator.userAgent.match(/rv:11/),
          ieEDGE = navigator.userAgent.match(/Edge/g),
          ieVer = ie ? ie[1] : ie11 ? 11 : ieEDGE ? 12 : -1;

        if (ie && ieVer < 10) {
          console.log('No blobs on IE ver<10');
          return;
        }

        var textFileAsBlob = new Blob([textToWrite], {
          type: 'text/plain',
        });

        if (ieVer > -1) {
          window.navigator.msSaveBlob(textFileAsBlob, fileNameToSaveAs);
        } else {
          var downloadLink = document.createElement('a');
          downloadLink.download = fileNameToSaveAs;
          downloadLink.href = window.URL.createObjectURL(textFileAsBlob);
          downloadLink.onclick = function (e) {
            document.body.removeChild(e.target);
          };
          downloadLink.style.display = 'none';
          document.body.appendChild(downloadLink);
          downloadLink.click();
        }
      }

      function DateforFile() {
        var d = new Date(),
          thisyear = d.getFullYear();
        thismonth = d.getMonth();
        thismonth = thismonth + 1;

        if (thismonth < 10) {
          thismonth = '0' + thismonth;
        }

        thisday = d.getDate();

        if (thisday < 10) {
          thisday = '0' + thisday;
        }

        h = (d.getHours() < 10 ? '0' : '') + d.getHours();
        m = (d.getMinutes() < 10 ? '0' : '') + d.getMinutes();
        return thisyear + '-' + thismonth + '-' + thisday + ' ' + h + '_' + m;
      }

      // captures each form element value in a JSON object and stores it in hidden element 'parseme'
      function storeFormValuesToHiddenElement() {
        let thisVersion = '';
        const theVersionTemp = document.getElementById('Theversion').value;
        const thisVersionTemp = document.getElementById('thisVersion').value;
        const bfVersionTemp = localStorage.getItem('BFVersion');
        if (theVersionTemp.length >= 5) {
            thisVersion = theVersionTemp;
        } else
        if (thisVersionTemp.length >= 5) {
            thisVersion = thisVersionTemp;
        } else
        if (bfVersionTemp.length >= 5) {
            thisVersion = bfVersionTemp;
        } else {
            thisVersion = 'null';
        }
        const EventTitle = document.getElementById('EventTitle').value;
        const MessageNumber = document.getElementById('MessageNumber').value;
        const address = document.getElementById('address').value;
        const Location = document.getElementById('Location').value;
        const msgsubject = document.getElementById('msgsubject').value;
        const numlines = document.getElementById('numlines').value;
        const TheData = document.getElementById('TheData').value;
        const Comment = document.getElementById('Comment').value;
        const previousRecord = JSON.parse(localStorage.getItem('previousRecord'));

        const formObject = JSON.stringify({
          thisVersion,
          EventTitle,
          MessageNumber,
          address,
          Location,
          msgsubject,
          numlines,
          TheData,
          Comment,
          previousRecord,
        });

        console.log('formObject to be stored in hidden element', formObject);
        document.getElementById('parseme').value = formObject;
      }

      // takes values stored in parseme hidden element, iterates through form elements and populates them with values
      function populateForm() {
        console.log('entered populateForm function');
        const parseMeValue = JSON.parse(document.getElementById('parseme').value);
        console.log('parseMeValue from hidden element', parseMeValue);
        if (!Object.prototype.toString.call(parseMeValue) === '[object Object]') {
          console.log('parseme element value could not be parsed by JSON. Exiting function.');
          return;
        }

        for (var i in parseMeValue) {
            var el =
                document.getElementById(i) ||
                document.querySelector('[name=' + i + ']');
            //   if (el.type === 'radio')
            //     el = document.querySelectorAll('[name=' + i + ']');
            try {
                if (i === 'previousRecord') {
                    console.log('processing previousRecord.');
                    const msgNumber = parseMeValue[i].messageNumber || 'none';
                    // display to the screen
                    document.getElementById('endOfPriorBatch').value = `#${parseMeValue[i].runner}, ${parseMeValue[i].action}, ${parseMeValue[i].time}, D:${parseMeValue[i].dayOfMonth}, M#${msgNumber}`;
                    // no further processing necessary
                    continue;
                } else {
                    console.log('i did not match previousRecord, it is actually:', i);
                }
                console.log('i:', i);
            } catch (err) {
                console.log('error in previousRecord block:', err);
                console.log('continuing...');
            }

            switch (typeof parseMeValue[i]) {
                case 'number':
                    el.checked = parseMeValue[i];
                    break;
                case 'object':
                    try {
                        if (el.options && parseMeValue[i] instanceof Array) {
                            for (var j = 0, jmax = el.options.length; j < jmax; ++j) {
                                if (parseMeValue[i].indexOf(el.options[j].value) > -1)
                                    el.options[j].selected = true;
                            }
                        }
                    }
                    catch (err) {
                        console.log('error reading an element:', err);
                    }

                    break;
                default:
                    if (el instanceof NodeList) {
                        for (var j = 0, jmax = el.length; j < jmax; ++j) {
                            if (el[j].value === parseMeValue[i]) el[j].checked = true;
                        }
                    } else {
                        el.value = parseMeValue[i];
                    }
            }
            // call the function that sets the previous record to the element as a string
            copyPreviousRecordFromLsToElement();
        }

        // getit();
        loadMessageHeadersIfEmpty();
        Fixfields();
      }

      function SaveData() {
        storeFormValuesToHiddenElement();
        store();  // update localstorage values
        saveTextAsFile();
      }

      function incrementMsgNum() {
        console
        const formMsgNum = Number.parseInt(document.getElementById('MessageNumber').value, 10);
        const lsMsgNum = Number.parseInt(localStorage.getItem('RTrackermsgNum'), 10);
        const incrMsgNum = formMsgNum ? formMsgNum + 1 : 1;
        document.getElementById('MessageNumber').value = incrMsgNum;

        if (lsMsgNum && lsMsgNum < incrMsgNum) {
          localStorage.setItem('RTrackermsgNum', incrMsgNum);
        }
      }

      window.onload = function () {
        const formVersion = '1.0.6';
        localStorage.setItem('BFVersion', formVersion);
        document.getElementById('thisVersion').innerText=`Version ${formVersion}`;
        document.getElementById('Theversion').value = formVersion;

        //Check the support for the File API support
        if (
          window.File &&
          window.FileReader &&
          window.FileList &&
          window.Blob
        ) {
          var fileSelected = document.getElementById('txtfiletoread');
          
          fileSelected.addEventListener(
            'change',
            function (e) {
              //Set the extension for the file
              var fileExtension = /text.*/;
              //Get the file object
              var fileTobeRead = fileSelected.files[0];
              //Check of the extension match
              if (fileTobeRead.type.match(fileExtension)) {
                //Initialize the FileReader object to read the file data
                var fileReader = new FileReader();

                fileReader.onload = function (e) {
                  document.getElementById('parseme').value = fileReader.result; // missing JSON.parse?
                  console.log('json parsed data stored in hidden element', document.getElementById('parseme').value);
                  populateForm();
                };
                fileReader.readAsText(fileTobeRead);
              } else {
                alert('Please select text file');
              }
            },
            false
          );
        } else {
          alert('Files are not supported');
        }

        setFormElementsWithLsValues();
        Fixfields();
      };

      function Fixfields() {
        AutoGrowTextArea(document.getElementById('TheData'));
      }

      // removes all localStorage values
      function clearLocalStorage() {
        localStorage.clear();
      }
    </script>

    <style type="text/css">
        body {
            font-family:Arial, Helvetica, sans-serif;
            font-size: 18px;
            background-color: rgb(220, 220, 220);
        }

        @media screen and (width < 650px) {
            label, input, textarea, select, button {
                font-size: .7em;
            }
            input {
                margin: 0.2em 0.2em;
            }
            input[type="checkbox"] {
                width: 1em;
                height: 1em;
            }
            .formTitleHeader {
                font-size: 2em;
            }
            .bibEntries {
                min-height: 3em;
                max-height: 6em;
            }
            .msgHeaderTitle {
                font-size: 0.7em;
            }
            .addressInput {
                min-width: 70%;
            }
            .block-line-div {
                display: block;
            }
            .readOnlyText {
                font-size: 0.6em;
            }
        }

        @media screen and (width >= 650px) {
            label, input, textarea, select, button {
                font-size: 1em;
            }
            input {
                margin: 0.3em 0.3em;
            }
            input[type="checkbox"] {
                width: 1.2em;
                height: 1.2em;
            }
            .formTitleHeader {
                font-size: 3em;
            }
            .bibEntries {
                min-height: 4em;
                max-height: 10em;
            }
            .msgHeaderTitle {
                font-size: 1.1em;
            }
            .addressInput {
                max-width: 55%;
            }
            .block-line-div {
                display: inline;
            }
        }

        hr {
            height: 0.1em;
            width: 90%;
        }
        textarea {
            width: 96%;
        }

        ul {
            list-style-type: none;
        }

        .screen-reader {
            /* only screen readers see this element */
            position: absolute;
            left: -500px;
            top: auto;
            width: 1px;
            height: 1px;
            overflow: hidden;
        }

        .div-across-auto-align {
            width:100%;
            margin:auto; 
            text-align:center;
        }

        .formTitleHeader {
            text-align: center;
            color:rgb(0,0,255);
            font-style: italic;
        }
      
        .msgHeaderTitle {
            color: rgb(0,0,255);
            text-align: center;
        }

        .maxSizeInputWidth {
            min-width: 75%;
        }

        .readOnlyText {
            color: rgb(84, 84, 84) !important;
            outline: none !important;
            cursor: default !important;
            opacity: unset !important;
        }

      /* Pop-up content shifted off-screen when not in view. Still readable by screen-reader software. When targeted it fills the browser window. */
      .pop-up {
        position: absolute;
        top: 0em;
        left: -500em;
      }

      .pop-up:target {
        position: static;
        left: 0em;
      }

      /* The pop-up itself */
      .popBox {
        background: rgb(255, 255, 255);
        /* alternatively fixed width / height and negative margins from 50% */
        position: absolute;
        left: 2em;
        right: 2em;
        top: 2em;
        bottom: 2em;
        z-index: 10;
        border: 3px solid rgb(0, 0, 150);
        /* CSS3 where available: rounded corners, drop-shadow, and fade in. */
        border-radius: 0.25rem;
        box-shadow: 0rem 0.5rem 0.5rem rgb(255, 255, 255);
        opacity: 0;
        transition: opacity 0.8s ease-out;
      }

      :target .popBox {
        position: fixed;
        opacity: 1;
      }

      /* The pop-ups close link, moved via CSS to the top right of the pop-up */
      .close:link,
      .close:visited {
        position: absolute;
        top: -0.75em;
        right: -0.75em;
        display: block;
        width: 2em;
        height: 2em;
        line-height: 1.8;
        padding: 0em;
        text-align: center;
        text-decoration: none;
        background-color: rgb(0,0,0);
        border: 2px solid rgb(255,255,255);
        color: rgb(255,255,255);
        border-radius: 50%;
        box-shadow: 0rem 0rem 0.5rem 0.5rem;
      }

      .close:before {
        content: 'X';
      }

      .close:hover,
      .close:active,
      .close:focus {
        box-shadow: 0rem 0rem 0.5rem 0.5rem;
        background-color: rgb(192, 192, 192);
        color: rgb(0,0,0);
      }

      .close span {
        text-indent: -200em;
        display: block;
      }

      /* The pop-up content div will scroll if it has too much content */
      .popScroll {
        position: absolute;
        top: 1rem;
        left: 1rem;
        right: 1rem;
        bottom: 1rem;
        overflow-y: auto;
        padding-right: 0.5em;
      }

      input {
        padding: 0.2em 0.2em;
        border-radius: 0.5rem;
      }

      input[type='submit'] {
        color: rgb(0, 0, 0);
        font-weight: bold;
        background-color: rgb(113, 169, 253);
        padding-left: 0.8em;
        padding-right: 0.8em;
      }

      .clearDataButton {
        color: black;
        background-color: rgb(255, 153, 0);
        font-weight: bold;
      }

      input[type='button'] {
        color: black;
        padding-left: 0.8em;
        padding-right: 0.8em;
      }

      textarea, select {
        padding: 0.3em 0.3em;
        border: rgb(0,0,0) solid 0.15em;
        border-radius: 0.5rem;
      }

    input:hover, textarea:hover, select:hover {
        cursor: pointer;
        opacity: 0.8;
    }

    input:focus, textarea:focus, select:focus {
        outline: rgb(255, 153, 0) solid 3px;
    }
    </style>
  </head>

<body>
    <section>
    <form 
        onsubmit="return confirm('To complete your form submission, click OK and close the browser tab. You will return to the new message window so you can post your message to the outbox.');"
        method="post" id="myform" enctype="multipart/form-data" action="http://{FormServer}:{FormPort}">
            <div style="text-align: center;">
                <label class="formTitleHeader">Bigfoot Bib Report</label>
            </div>
            <div style="text-align: center;">
                <input type="button" value="Form Information - READ" onclick="location.href='#pop1'" />
                <label id="thisVersion"></label>
            </div>
        <hr />

        <div class="msgHeaderTitle">Message Header</div>
        <div class="div-across-auto-align">
            <div class="block-line-div">
                <label for="EventTitle">Event Name:</label>
                <input name="EventTitle" type="text" id="EventTitle" maxlength="40" onchange="store();" placeholder="Race or Event Name" required />
            </div>
            <div class="block-line-div">
                <label for="MessageNumber">Message #</label>
                <input name="MessageNumber" type="text" id="MessageNumber" maxlength="3" style="max-width: 3em;" onchange="store();" placeholder="1" />
                <input name="incrMsgNum" type="button" id="incrMsgNum" value="increment" onclick="incrementMsgNum();" />
                <!-- invisible label that screen readers can still use -->
                <label for="incrMsgNum" class="screen-reader">Increment</label>
            </div>
        </div>

        <div class="div-across-auto-align">
            <div class="block-line-div">
                <label for="address">Send to:</label>
                <input name="address" type="text" id="address" class="addressInput" maxlength="40" onchange="store();"
                    title="Separate multiple calls or addresses with a semicolon;" placeholder="Winlink Radio Call or Email"
                    required />
            </div>

            <div class="aidStnSpan block-line-div">
                <label for="Location">Aid Station:</label>
                <select name="Location" id="Location" onchange="store();" required>
                    <option value="MM_Marble Mountain SnoPark">Marble Mountain SnoPark</option>
                    <option value="BL_Blue Lake">Blue Lake</option>
                    <option value="WR_Windy Ridge">Windy Ridge</option>
                    <option value="JR_Johnston Ridge">Johnston Ridge</option>
                    <option value="CW_Coldwater Lake">Coldwater Lake</option>
                    <option value="NP_Norway Pass">Norway Pass</option>
                    <option value="EP_Elk Pass">Elk Pass</option>
                    <option value="WM_Wright Meadow (Rd.9327)">Wright Meadow (Rd.9327)</option>
                    <option value="SB_Spencer Butte">Spencer Butte</option>
                    <option value="LR_Lewis River">Lewis River</option>
                    <option value="QR_Quartz Ridge">Quartz Ridge</option>
                    <option value="CB_Council Bluff">Council Bluff</option>
                    <option value="CH_Chain of Lakes">Chain of Lakes</option>
                    <option value="KT_Klickitat">Klickitat</option>
                    <option value="TS_Twin Sisters">Twin Sisters</option>
                    <option value="OC_Owens Creek">Owen&acute;s Creek</option>
                    <option value="FN_Finish Line">Finish (Bigfoot Base)</option>
                </select>
            </div>
        </div>

        <!-- hidden elements -->
        <input name="Theversion" type="hidden" id="Theversion" />
        <input name="FormatNote" type="hidden" id="FormatNote"
            value="* The entries in this email are TAB delimited. This allows you to copy and paste into a spreadsheet." />
        <textarea name="beforeformatting" id="beforeformatting" style="display: none"></textarea>
        <input type="file" id="txtfiletoread" accept=".txt" style="display: none" />
        <input name="sendto" type="hidden" id="sendto" />
        <textarea name="parseme" id="parseme" style="display: none"></textarea>
        <!-- end hidden elements -->

        <div class="div-across-auto-align">
            <label for="msgsubject">Subject:</label>
            <input name="msgsubject" type="text" id="msgsubject" readonly="readonly" maxlength="40" class="maxSizeInputWidth readOnlyText" />
        </div>

        <hr />
        <div class="msgHeaderTitle">Bib Data Entry</div>

        <div class="div-across-auto-align">
            <div class="block-line-div">
                <label for="RiderNum">Bib Number:</label>
                <input name="RiderNum" type="text" id="RiderNum" maxlength="15" style="max-width: 6em;"
                onkeypress="if(event.keyCode==13){a=setfocus(); return false;}"
                onblur="javascript:this.value=this.value.trim();this.value=this.value.toUpperCase(); putTime();" />
            </div>
            <div class="block-line-div">
                <label for="Timefld">Time:</label>
                <input name="Timefld" type="text" id="Timefld" maxlength="6" style="max-width: 6em;"
                    onkeypress="if(event.keyCode==13){alert('Click: IN - OUT - DROP');return false;}"
                    onblur=" this.value=this.value.trim(); " />
                <input type="checkbox" id="yesterday" name="yesterday" value="Yesterday" />    
                <label for="yesterday">Yesterday</label>
            </div>
        </div>

        <div id="inOutDropBtns"  class="div-across-auto-align">
            <div class="block-line-div">
                <label for="inOutDropBtns">Click an Action button to create a record:</label>
            </div>
            <div class="block-line-div">
                <input name="Inbtn" type="button" id="Inbtn" onclick="AddIn();" value="In"
                title="Participant arrived at this station." />
                <input name="Outbtn" type="button" id="Outbtn" onclick="AddOut();" value="Out"
                title="Participant departed from this station." />
                <input name="Dropbtn" type="button" id="Dropbtn" onclick="AddDrop()" value="Drop"
                title="Participant dropped from race." />
            </div>
        </div>

        <hr />

            <div class="div-across-auto-align">
                <label for="numlines">Entry Count:</label>
                <input name="numlines" type="text" id="numlines" size="3" class="readOnlyText" readonly title="Number of bib entries submitted." />
                <label for="endOfPriorBatch">End Of Prior:</label>
                <input name="endOfPriorBatch" type="text" id="endOfPriorBatch" size="25" class="readOnlyText" readonly title="The last saved bib record."></input>
            </div>
            <div class="div-across-auto-align">
                <textarea name="TheData" placeholder="Limit to a sensible number of entries." id="TheData" class="bibEntries" maxlength="1000"
                onkeypress="if(event.keyCode==13){countLines2() }" onblur="countLines2()"></textarea>
            </div>
            <div class="div-across-auto-align">
                <label for="Comment">Comments:</label>
                <textarea name="Comment" id="Comment" maxlength="300" onkeyup="AutoGrowTextArea(this)"
                    placeholder="Enter a short comment. Limited to 300 characters."></textarea>
            </div>

        <div class="div-across-auto-align">
            <div class="block-line-div">
            <input title="After submitting, close browser, then address message for posting" class="SubmitBtn"
                enctype="multipart/form-data" id="Submit" method="Post" name="Submit" value="SUBMIT" type="submit" />
            <input name="savebtn" type="button" class="saveDataButton" id="savebtn" onclick="SaveData()"
                value="Save Race data" title="Save data to a file." />
            </div>            
            <div class="block-line-div">
            <input name="loadbtn" type="button" class="loadDataButton" id="loadbtn"
                onclick="document.getElementById('txtfiletoread').click();" value="Load Race data"
                title="Load data from a file." />
            <input name="doclear" type="button" id="doclear" onclick="Docleardata()" value="Clear Entries"
                    title="Clear all runner entries." class="clearDataButton" />
            </div>
        </div>
    </form>
    </section>
    <section>
    <div id="pop1" class="pop-up">
        <!-- The pop-up block -->

        <div class="popBox">
            <!-- If the content becomes larger than the pop-up this div will scroll the content -->

            <div class="popScroll">
                <h1>Winlink Operator Instructions</h1>

                <h2>The form is broken up into roughly three sections:</h2>

                <ul>
                    <li>Top: Header information with event, location, and message information.</li>
                    <li>Middle: For entering bib data, and to save/restore data to/from a file.</li>
                    <li>Bottom: To view entered bib data, add comments, and to submit the data for posting a new Winlink
                        Express
                        message.</li>
                </ul>

                <p>Note:<em>Keyboard-only mode is supported!</em></h4>
                <ul>
                    <li>
                        <kbd>Tab</kbd> key to move between screen elements.
                    </li>
                    <li>
                        <kbd>Spacebar</kbd> or <kbd>Enter</kbd> to activate a highlighted element.
                    </li>
                </ul>

                <h3>Top Section</h3>

                <ol>
                    <li>Enter this Event Name for example &quot;Bigfoot 2023&quot;.</li>
                    <li>Enter a Message Number starting with 1. Increment it for each time you create a new message for
                        the
                        current Aid Station.</li>
                    <li>Enter the recipient's amateur call sign in Send To field.</li>
                    <li>Aid Station: Click it, or press the Spacebar to see a list and click or select one with arrows
                        and the
                        Enter key.</li>
                    <li>Subject Line: It will be entered automagically for you. Try to resist the urge to change it.
                    </li>
                </ol>

                <h3>Middle Section</h3>

                <p>With a list of bib numbers and the times they entered and left the Aid Station, or dropped from the
                    event,
                    enter bib numbers into the form:</p>

                <ol>
                    <li>Enter Bib Number: Limited to 15 digits (should be more than enough for any event).</li>
                    <li>Enter The Time: This should be 24hr time like <em>HH:MM</em>. The browser might suggest the
                        current time
                        for you.</li>
                    <li>Check This Box If Time Was Yesterday: Runners come and go from Aid Stations all time of day and
                        night. You
                        might have a list of runners that arrived yesterday and left (or dropped) today.</li>
                    <li>Click IN, OUT, or DROP once to enter that bib into the record.</li>
                </ol>

                <h4>IN, OUT, and DROP Actions</h4>

                <ul>
                    <li>
                        IN: The runner (bib) arrived at the Aid Station.
                    </li>
                    <li>
                        OUT: The runner left the Aid Station.
                    </li>
                    <li>
                        DROP: Use if the runner has notified Aid Station Staff that they are bowing out of the race, or
                        they have
                        been disqualified by race officials.
                    </li>
                </ul>

                <p>Save Race Data and Load Race Data are discussed below.</p>
                <p>For any bib entries that need additional explanation (like DROP) use the &quot;Comments&quot; area to
                    free-form a statement.
                    <em>Keep the message short</em> and to the point.
                    If you have more than about 30 words to say, write it down and send all of it via a separate Winlink
                    message,
                    or by voice directly to Net Control.
                </p>

                <h3>Bottom Section</h3>

                <p>Number of Entries: This accurately counts the number of bib entries already in the form.
                    Try to keep the total list size to less than 50.</p>
                <p>Use the &quot;Clear Entries&quot; button to remove <em>all entries</em> from the text.
                    Use wisely <em>there is no backup</em>.</p>
                <hr />

                <h2>
                    Saving and Loading Race Data
                </h2>

                <p>
                    Use the Save Data Race Data button to store the bib entries into a plain text file.
                    The file will be named with the current date and time with a &quot;txt&quot; file extension so any
                    text editor
                    can open it.
                    The file will be stored in your browser's download folder.
                    You can rename the file to something more meaningful if you like.
                </p>
                <p>
                    The information that is sent via WinLink can be copied and pasted directly into an excel
                    spreadsheet,
                    or saved to a file and then imported as a &quot;Tab Delimited&quot; file.
                </p>
                <p>
                    The Subject Line will be formatted for you, for example:
                    <code>BigFoot 2023 Marble Mountain SnoPark Message #1</code>
                </p>

                <ul>
                    <li>BigFoot 2023: The Race or Event Name entered at the top of the form.</li>
                    <li>Marble Mountain SnoPark: The Aid Station selected at the top of the form.</li>
                    <li>Message #1: The Message Number entered at the top of the form.</li>
                </ul>
                <p>The &quot;Send To&quot; data is used to address the Winlink Message to the intended recipient, so it
                    is not
                    included in the subject line.</p>

                <hr />

                <h2>Credits</h2>
                <p>
                    The original form was designed by Greg KG6SJT of WDT (Winlink Development Team).
                </p>
                <p>
                    <em>This version of the form has NOT been tested by UltraLive
                        staff.</em>
                </p>
            </div>
            <!-- The close pop-up link correctly positioned at the end of the content block -->

            <a class="close" href="#links">
                <span>Back to links</span>
            </a>
        </div>
    </div>

    <div id="pop2" class="pop-up">
        <!-- The pop-up block -->

        <div class="popBox">
            <!-- If the content becomes larger than the pop-up this div will scroll the content -->

            <div class="popScroll">
                <p>
                    Ultralive formatting Information From
                    <a href="https://docs.google.com/document/d/1J01uupj-9hcXdfFJV5jQau0pp8E6EL_dVkS7H5RjulM/edit"
                        target="_blank">https://docs.google.com/document/d/1J01uupj-9hcXdfFJV5jQau0pp8E6EL_dVkS7H5RjulM/edit</a>
                    <br />
                    Suggest you download and have a copy for event.
                    <br />
                </p>
            </div>

            <!-- The close pop-up link correctly positioned at the end of the content block -->
            <a class="close" href="#links">Back to links</a>
        </div>
    </div>
    </section>
</body>
</html>
